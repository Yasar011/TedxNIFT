<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Panel – Movie Night Booking</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"/>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.5/css/dataTables.bootstrap5.min.css"/>
  <style>
    :root {
      --bg: #2c2f33;
      --panel: #23272a;
      --accent: #7289da;
      --paid: #43b581;
      --confirmed: #faa61a;
      --info: #3498db;
    }
    body { background-color: var(--bg); color: #eee; }
    .sidebar { background: var(--panel); min-height: 100vh; width: 220px; }
    .sidebar .nav-link.active { background: var(--accent); color: white; }
    .stat-card, .chart-section, .booking-section, .form-section, #verifyTicketsSection {
      background-color: var(--panel);
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .chart-container { height: 280px; }
    .hidden { display: none; }
    #loader {
      position: fixed; top: 0; left: 0;
      width: 100%; height: 100%;
      background: var(--bg);
      display: flex; justify-content: center; align-items: center;
      z-index: 9999;
    }
    #loader.hidden { display: none; }
    #ticket-details { white-space: pre-wrap; font-size: 1rem; margin-top: .5rem; }
  </style>
  <script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body>
  <div id="loader">
    <div class="spinner-border text-light" style="width:3rem;height:3rem;">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>
  <div class="d-flex">
    <nav class="sidebar p-3 d-flex flex-column">
      <h4 class="text-white">🎬 Movie Night</h4>
      <ul class="nav flex-column mt-4">
        <li><a class="nav-link active" id="dashboardTab" href="#">Dashboard</a></li>
        <li><a class="nav-link" id="bookingsTab" href="#">Bookings</a></li>
        <li><a class="nav-link" id="manualEntryTab" href="#">Manual Entry</a></li>
        <li><a class="nav-link" id="verifyTicketsTab" href="#">Verify Tickets</a></li>
      </ul>
      <a href="#" class="btn btn-outline-light mt-auto">Logout</a>
    </nav>
    <div class="flex-grow-1 p-4">
      <!-- Dashboard, Bookings, Manual Entry (unchanged) -->
      <div id="verifyTicketsSection" class="hidden">
        <h2 class="text-center mb-4" style="color: var(--accent);">Verify Tickets</h2>
        <div id="qr-reader" style="width:320px;margin:auto;"></div>
        <div id="scan-result" class="text-center mt-3" style="font-weight:bold;"></div>
        <div id="ticket-details" class="text-center"></div>
        <button id="confirmCheckinBtn" class="btn btn-success d-block mx-auto mt-3" style="display:none;">
          Confirm Check-In
        </button>
        <button id="stopScannerBtn" class="btn btn-danger d-block mx-auto mt-3" style="display:none;">
          Stop Scanner
        </button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-app.js";
    import { getDatabase, ref, update } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-database.js";

    const app = initializeApp({
      apiKey: "...", authDomain: "...",
      databaseURL: "...", projectId: "...",
      storageBucket: "...", messagingSenderId: "...",
      appId: "..."
    });
    const db = getDatabase(app);

    let html5QrCode = null, lastTicketData = null;
    const scanResult = document.getElementById("scan-result");
    const ticketDetailsDiv = document.getElementById("ticket-details");
    const confirmBtn = document.getElementById("confirmCheckinBtn");
    const stopBtn = document.getElementById("stopScannerBtn");

    function startScanner() {
      scanResult.textContent = "Starting scanner…"; scanResult.style.color = "#eee";
      ticketDetailsDiv.textContent = ""; confirmBtn.style.display = "none";
      lastTicketData = null; stopBtn.style.display = "inline-block";
      if (!html5QrCode) html5QrCode = new Html5Qrcode("qr-reader");
      html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        onScanSuccess,
        () => {}
      ).catch(e => {
        scanResult.textContent = `Camera start failed: ${e}`;
        scanResult.style.color = "red";
      });
    }

    function stopScanner() {
      if (html5QrCode) {
        html5QrCode.stop().then(() => {
          scanResult.textContent = "Scanner stopped."; scanResult.style.color = "#eee";
          stopBtn.style.display = "none"; html5QrCode.clear();
        });
      }
    }

    function onScanSuccess(decodedText) {
      stopScanner();
      let data;
      try {
        data = JSON.parse(decodedText);
      } catch {
        scanResult.textContent = "❌ Invalid QR format"; scanResult.style.color = "red";
        return;
      }
      lastTicketData = data;
      const {
        name, seat, movie, time, date, venue, price,
        department, semester, email, ph
      } = data;

      // Show details
      ticketDetailsDiv.textContent =
        `Name: ${name}\nSeat: ${seat}\nMovie: ${movie}\nTime: ${time}\nDate: ${date}\nVenue: ${venue}\nPrice: ${price}\nDept: ${department}\nSem: ${semester}\nEmail: ${email}\nPhone: ${ph}`;

      // Validate against Firebase
      const seatRef = ref(db, `seats/${seat}`);
      fetch(seatRef.toString() + ".json")  // simple GET
        .then(r => r.json())
        .then(snapshot => {
          if (!snapshot || !snapshot.status || snapshot.status === "available") {
            scanResult.textContent = "❌ Ticket not booked"; scanResult.style.color = "red";
          }
          else if (snapshot.checkedIn) {
            scanResult.textContent = "⚠️ Already checked in"; scanResult.style.color = "orange";
          }
          else {
            scanResult.textContent = "✅ Valid ticket"; scanResult.style.color = "limegreen";
            confirmBtn.style.display = "inline-block";
          }
        })
        .catch(() => {
          scanResult.textContent = "❌ Verification error"; scanResult.style.color = "red";
        });
    }

    confirmBtn.addEventListener("click", () => {
      if (!lastTicketData) return;
      const seat = lastTicketData.seat;
      update(ref(db, `seats/${seat}`), { checkedIn: true, checkInTimestamp: Date.now() })
        .then(() => {
          alert("Checked in successfully");
          confirmBtn.style.display = "none";
          scanResult.textContent = "✅ Checked in"; scanResult.style.color = "limegreen";
        })
        .catch(e => alert("Update failed: " + e.message));
    });

    stopBtn.addEventListener("click", stopScanner);

    // Tab logic
    document.getElementById("verifyTicketsTab").addEventListener("click", () => {
      document.querySelectorAll(".nav-link").forEach(a => a.classList.remove("active"));
      document.querySelectorAll("> div > div[id$='Section']").forEach(s => s.classList.add("hidden"));
      document.getElementById("verifyTicketsSection").classList.remove("hidden");
      document.getElementById("verifyTicketsTab").classList.add("active");
      startScanner();
    });

    // On load, show dashboard (existing logic)…
    window.addEventListener("load", () => {
      document.getElementById("loader").classList.add("hidden");
    });
  </script>
</body>
</html>
