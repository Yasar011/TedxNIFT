<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Panel â€“ Movie Night Booking</title>
  
  <!-- Optimized CSS Loading with preload -->
  <link rel="preload" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <link rel="preload" href="https://cdn.datatables.net/1.13.5/css/dataTables.bootstrap5.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  
  <!-- Fallback for CSS -->
  <noscript>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.5/css/dataTables.bootstrap5.min.css"/>
  </noscript>

  <style>
    :root {
      --bg: #2c2f33;
      --panel: #23272a;
      --accent: #7289da;
      --paid: #43b581;
      --confirmed: #faa61a;
      --info: #3498db;
    }
    
    body { 
      background-color: var(--bg); 
      color: #eee; 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    .sidebar { 
      background: var(--panel); 
      min-height: 100vh; 
      width: 220px; 
      transition: transform 0.3s ease;
    }
    
    .sidebar .nav-link.active { 
      background: var(--accent); 
      color: white; 
      transition: all 0.2s ease;
    }
    
    .stat-card, .chart-section, .booking-section, .form-section {
      background-color: var(--panel); 
      border-radius: 10px; 
      padding: 20px; 
      margin-bottom: 20px;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }
    
    .chart-container { 
      height: 280px; 
      position: relative;
    }
    
    .table-status.paid { 
      background-color: var(--paid); 
      color: black; 
      border-radius: 4px;
      padding: 2px 8px;
    }
    
    .table-status.confirmed { 
      background-color: var(--confirmed); 
      color: black; 
      border-radius: 4px;
      padding: 2px 8px;
    }
    
    .hidden { display: none; }
    
    /* Loading States */
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    .main-loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--bg);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      transition: opacity 0.3s ease;
    }
    
    .main-loading.hidden {
      opacity: 0;
      pointer-events: none;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .fade-in {
      animation: fadeIn 0.5s ease forwards;
    }
    
    /* Skeleton Loading */
    .skeleton {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: loading 1.5s infinite;
      border-radius: 4px;
    }
    
    @keyframes loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    
    .skeleton-row {
      height: 20px;
      margin-bottom: 10px;
    }
    
    /* Button States */
    .btn-loading {
      position: relative;
      pointer-events: none;
    }
    
    .btn-loading::after {
      content: "";
      position: absolute;
      width: 16px;
      height: 16px;
      top: 50%;
      left: 50%;
      margin-left: -8px;
      margin-top: -8px;
      border: 2px solid transparent;
      border-top-color: #ffffff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
  </style>
</head>

<body>
  <!-- Main Loading Overlay -->
  <div id="mainLoading" class="main-loading">
    <div class="text-center">
      <div class="loading-spinner" style="width: 50px; height: 50px; border-width: 5px;"></div>
      <div class="mt-3">
        <h5>Loading Admin Panel...</h5>
        <p class="text-muted">Please wait while we initialize the system</p>
      </div>
    </div>
  </div>

  <div class="d-flex" style="opacity: 0;" id="mainContent">
    <nav class="sidebar p-3 d-flex flex-column">
      <h4 class="text-white">ðŸŽ¬ Movie Night</h4>
      <ul class="nav flex-column mt-4">
        <li><a class="nav-link active" id="dashboardTab" href="#" data-target="dashboardSection">Dashboard</a></li>
        <li><a class="nav-link" id="bookingsTab" href="#" data-target="bookingSection">Bookings</a></li>
        <li><a class="nav-link" id="manualEntryTab" href="#" data-target="manualEntrySection">Manual Entry</a></li>
      </ul>
      <a href="#" class="btn btn-outline-light mt-auto">Logout</a>
    </nav>

    <div class="flex-grow-1 p-4">
      <!-- DASHBOARD -->
      <div id="dashboardSection">
        <h2 class="text-center mb-4" style="color: var(--accent);">Admin Dashboard</h2>
        
        <!-- Loading State for Stats -->
        <div id="statsLoading" class="row g-3 mb-4">
          <div class="col-md-3"><div class="stat-card"><div class="skeleton skeleton-row"></div><div class="skeleton skeleton-row"></div></div></div>
          <div class="col-md-3"><div class="stat-card"><div class="skeleton skeleton-row"></div><div class="skeleton skeleton-row"></div></div></div>
          <div class="col-md-3"><div class="stat-card"><div class="skeleton skeleton-row"></div><div class="skeleton skeleton-row"></div></div></div>
          <div class="col-md-3"><div class="stat-card"><div class="skeleton skeleton-row"></div><div class="skeleton skeleton-row"></div></div></div>
        </div>
        
        <!-- Actual Stats -->
        <div id="statsContent" class="row g-3 mb-4 hidden">
          <div class="col-md-3"><div class="stat-card text-center"><h6>Total Seats</h6><h2 id="totalSeatsStat">0</h2></div></div>
          <div class="col-md-3"><div class="stat-card text-center"><h6>Booked</h6><h2 id="bookedSeatsStat" class="text-success">0</h2></div></div>
          <div class="col-md-3"><div class="stat-card text-center"><h6>Seats Left</h6><h2 id="leftSeatsStat" class="text-warning">0</h2></div></div>
          <div class="col-md-3"><div class="stat-card text-center"><h6>Needs Snacks</h6><h2 id="needsSnacksStat" style="color: var(--info);">0</h2></div></div>
        </div>
        
        <!-- Charts -->
        <div class="row g-4" id="chartsContainer">
          <div class="col-md-4">
            <div class="chart-section">
              <h6>By Status</h6>
              <div class="chart-container">
                <div id="statusChartLoading" class="skeleton" style="height: 100%; border-radius: 50%;"></div>
                <canvas id="statusChart" class="hidden"></canvas>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="chart-section">
              <h6>By Department</h6>
              <div class="chart-container">
                <div id="deptChartLoading" class="skeleton" style="height: 100%; border-radius: 50%;"></div>
                <canvas id="deptChart" class="hidden"></canvas>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="chart-section">
              <h6>By Semester</h6>
              <div class="chart-container">
                <div id="semChartLoading" class="skeleton" style="height: 100%; border-radius: 50%;"></div>
                <canvas id="semChart" class="hidden"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- BOOKINGS -->
      <div id="bookingSection" class="booking-section hidden">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h2 class="text-center mb-0" style="color: var(--accent);">Bookings Table</h2>
          <div>
            <button id="exportCSV" class="btn btn-info btn-sm me-2">
              <span class="btn-text">Export CSV</span>
            </button>
            <button id="exportXLSX" class="btn btn-success btn-sm">
              <span class="btn-text">Export Excel</span>
            </button>
          </div>
        </div>
        
        <!-- Table Loading State -->
        <div id="tableLoading" class="text-center py-5">
          <div class="loading-spinner"></div>
          <p class="mt-2">Loading bookings...</p>
        </div>
        
        <table id="seatTable" class="table table-striped table-hover hidden" style="width:100%">
          <thead>
            <tr><th>#</th><th>Seat</th><th>Name</th><th>Phone</th><th>Dept</th><th>Sem</th><th>Snacks</th><th>Status</th><th>Actions</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- MANUAL ENTRY -->
      <div id="manualEntrySection" class="form-section hidden">
        <h2 class="text-center mb-4" style="color: var(--accent);">Manual Booking Entry</h2>
        <form id="manualEntryForm" style="max-width: 600px; margin: auto;">
          <div class="mb-3"><label>Seat Number</label><input type="text" class="form-control" id="seatNumber" required /></div>
          <div class="mb-3"><label>Name</label><input type="text" class="form-control" id="userName" required /></div>
          <div class="mb-3"><label>Phone Number</label><input type="text" class="form-control" id="phoneNumber" required /></div>
          <div class="mb-3">
            <label>Department</label>
            <select class="form-select" id="department" required>
              <option value="" disabled selected>Select Department</option>
              <option>BFT</option><option>AD</option><option>FD</option><option>FC</option><option>TD</option>
              <option>MFM</option><option>FACULTY</option><option>STAFF</option><option>OTHER</option>
            </select>
          </div>
          <div class="mb-3">
            <label>Semester</label>
            <select class="form-select" id="semester" required>
              <option value="" disabled selected>Select Semester</option>
              <option>1</option><option>2</option><option>3</option><option>4</option>
              <option>5</option><option>6</option><option>7</option><option>8</option><option>Other</option>
            </select>
          </div>
          <div class="mb-3">
            <label>Needs Snacks</label>
            <select class="form-select" id="snacks">
              <option value="no">No</option>
              <option value="yes">Yes</option>
            </select>
          </div>
          <div class="mb-3">
            <label>Status</label>
            <select class="form-select" id="status">
              <option value="paid">Paid</option>
              <option value="confirmed">Confirmed</option>
            </select>
          </div>
          <button type="submit" class="btn btn-primary w-100">
            <span class="btn-text">Submit Booking</span>
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- Edit Booking Modal -->
  <div class="modal fade" id="editBookingModal" tabindex="-1" aria-labelledby="editBookingModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <form class="modal-content" id="editBookingForm">
        <div class="modal-header">
          <h5 class="modal-title" id="editBookingModalLabel">Edit Booking</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="editSeatId">
          <div class="mb-3"><label>Name</label><input type="text" class="form-control" id="editUserName" required /></div>
          <div class="mb-3"><label>Phone Number</label><input type="text" class="form-control" id="editPhoneNumber" required /></div>
          <div class="mb-3">
            <label>Department</label>
            <select class="form-select" id="editDepartment" required>
              <option>BFT</option><option>AD</option><option>FD</option><option>FC</option><option>TD</option>
              <option>MFM</option><option>FACULTY</option><option>STAFF</option><option>OTHER</option>
            </select>
          </div>
          <div class="mb-3">
            <label>Semester</label>
            <select class="form-select" id="editSemester" required>
              <option>1</option><option>2</option><option>3</option><option>4</option>
              <option>5</option><option>6</option><option>7</option><option>8</option><option>Other</option>
            </select>
          </div>
          <div class="mb-3">
            <label>Needs Snacks</label>
            <select class="form-select" id="editSnacks">
              <option value="no">No</option>
              <option value="yes">Yes</option>
            </select>
          </div>
          <div class="mb-3">
            <label>Status</label>
            <select class="form-select" id="editStatus">
              <option value="paid">Paid</option>
              <option value="confirmed">Confirmed</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">
            <span class="btn-text">Save Changes</span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Scripts loaded asynchronously -->
  <script>
    // Performance optimized script loader
    const ScriptLoader = {
      loaded: new Set(),
      
      async loadScript(src, id) {
        if (this.loaded.has(id)) return Promise.resolve();
        
        return new Promise((resolve, reject) => {
          const script = document.createElement('script');
          script.src = src;
          script.async = true;
          script.onload = () => {
            this.loaded.add(id);
            resolve();
          };
          script.onerror = reject;
          document.head.appendChild(script);
        });
      },
      
      async loadMultiple(scripts) {
        const promises = scripts.map(({src, id}) => this.loadScript(src, id));
        return Promise.all(promises);
      }
    };

    // Critical scripts first
    const criticalScripts = [
      { src: 'https://code.jquery.com/jquery-3.6.0.min.js', id: 'jquery' },
      { src: 'https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js', id: 'bootstrap' }
    ];

    // Non-critical scripts (loaded after main content)
    const nonCriticalScripts = [
      { src: 'https://cdn.jsdelivr.net/npm/chart.js', id: 'chartjs' },
      { src: 'https://cdn.datatables.net/1.13.5/js/jquery.dataTables.min.js', id: 'datatables' },
      { src: 'https://cdn.datatables.net/1.13.5/js/dataTables.bootstrap5.min.js', id: 'datatables-bootstrap' },
      { src: 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js', id: 'xlsx' }
    ];

    // Initialize app after critical scripts
    ScriptLoader.loadMultiple(criticalScripts).then(() => {
      initializeApp();
      // Load non-critical scripts in background
      ScriptLoader.loadMultiple(nonCriticalScripts);
    });

    function initializeApp() {
      // Show main content with fade in animation
      setTimeout(() => {
        document.getElementById('mainLoading').classList.add('hidden');
        const mainContent = document.getElementById('mainContent');
        mainContent.style.opacity = '1';
        mainContent.classList.add('fade-in');
      }, 800);

      // Initialize Firebase
      initializeFirebase();
    }

    // Optimized Firebase initialization
    async function initializeFirebase() {
      try {
        const { initializeApp } = await import("https://www.gstatic.com/firebasejs/9.17.2/firebase-app.js");
        const { getDatabase, ref, onValue, update, set } = await import("https://www.gstatic.com/firebasejs/9.17.2/firebase-database.js");

        const app = initializeApp({
          apiKey: "AIzaSyBpew8ODVHmmGndhZxQ3VK_CEurW0_EQyU",
          authDomain: "nift-movie-nigt-apc.firebaseapp.com",
          databaseURL: "https://nift-movie-nigt-apc-default-rtdb.asia-southeast1.firebasedatabase.app",
          projectId: "nift-movie-nigt-apc",
          storageBucket: "nift-movie-nigt-apc.appspot.com",
          messagingSenderId: "736122244542",
          appId: "1:736122244542:web:69d88050a26fc8391dbdef"
        });

        const db = getDatabase(app);
        setupAppLogic(db, ref, onValue, update, set);
      } catch (error) {
        console.error('Firebase initialization failed:', error);
        showError('Failed to connect to database. Please refresh the page.');
      }
    }

    // Main application logic with performance optimizations
    function setupAppLogic(db, ref, onValue, update, set) {
      const seatsRef = ref(db, "seats");
      
      // Cached DOM elements
      const elements = {
        totalSeatsStat: document.getElementById('totalSeatsStat'),
        bookedSeatsStat: document.getElementById('bookedSeatsStat'),
        leftSeatsStat: document.getElementById('leftSeatsStat'),
        needsSnacksStat: document.getElementById('needsSnacksStat'),
        statsLoading: document.getElementById('statsLoading'),
        statsContent: document.getElementById('statsContent'),
        tableLoading: document.getElementById('tableLoading')
      };

      let seatTable = null;
      let statusChart, deptChart, semChart;
      let currentBookingData = {};
      
      // Debounced update function
      let updateTimeout = null;
      const debounceUpdate = (callback, delay = 300) => {
        clearTimeout(updateTimeout);
        updateTimeout = setTimeout(callback, delay);
      };

      // Initialize DataTable when needed
      const initializeDataTable = async () => {
        if (!seatTable && window.$ && $.fn.dataTable) {
          await new Promise(resolve => setTimeout(resolve, 100)); // Small delay for DOM
          seatTable = $("#seatTable").DataTable({ 
            order: [], 
            pageLength: 10,
            responsive: true,
            language: {
              loadingRecords: "Loading bookings...",
              emptyTable: "No bookings found"
            }
          });
          
          // Show table, hide loading
          document.getElementById('tableLoading').classList.add('hidden');
          document.getElementById('seatTable').classList.remove('hidden');
        }
      };

      // Tab navigation with performance optimization
      function setupNavigation() {
        document.querySelectorAll('.nav-link').forEach(link => {
          link.addEventListener('click', (e) => {
            e.preventDefault();
            const target = link.getAttribute('data-target');
            if (target) {
              toggleTab(`#${target}`, link);
            }
          });
        });
      }

      function toggleTab(sectionId, activeTab) {
        // Hide all sections
        document.querySelectorAll('#dashboardSection, #bookingSection, #manualEntrySection').forEach(section => {
          section.classList.add('hidden');
        });
        
        // Remove active class
        document.querySelectorAll('.nav-link').forEach(link => {
          link.classList.remove('active');
        });
        
        // Show target section
        document.querySelector(sectionId).classList.remove('hidden');
        activeTab.classList.add('active');
        
        // Initialize DataTable if switching to bookings
        if (sectionId === '#bookingSection') {
          debounceUpdate(() => initializeDataTable());
        }
      }

      // Optimized chart creation with error handling
      async function createChart(chartInstance, canvasId, dataObj, type = "pie") {
        try {
          if (!window.Chart) {
            // Wait for Chart.js to load
            await new Promise(resolve => {
              const checkChart = () => {
                if (window.Chart) resolve();
                else setTimeout(checkChart, 100);
              };
              checkChart();
            });
          }

          if (chartInstance) chartInstance.destroy();
          
          const canvas = document.getElementById(canvasId);
          const loading = document.getElementById(`${canvasId}Loading`);
          
          if (canvas && Object.keys(dataObj).length > 0) {
            const chart = new Chart(canvas, {
              type,
              data: {
                labels: Object.keys(dataObj),
                datasets: [{
                  data: Object.values(dataObj),
                  backgroundColor: ['#43b581','#faa61a','#7289da','#e74c3c','#3498db','#f1c40f']
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: { position: 'top' }
                },
                animation: {
                  animateScale: true,
                  animateRotate: true
                }
              }
            });
            
            // Hide loading, show chart
            if (loading) loading.classList.add('hidden');
            canvas.classList.remove('hidden');
            
            return chart;
          }
        } catch (error) {
          console.error(`Error creating ${canvasId}:`, error);
        }
        return null;
      }

      // Optimized data processing
      function processBookingData(data) {
        const total = 240;
        const stats = { status: {}, dept: {}, sem: {} };
        let booked = 0, snacks = 0;
        const tableData = [];

        Object.entries(data).forEach(([id, s]) => {
          if (s.status && s.status !== 'available') {
            booked++;
            if (s.snacks === "yes") snacks++;
            
            stats.status[s.status] = (stats.status[s.status] || 0) + 1;
            stats.dept[s.department] = (stats.dept[s.department] || 0) + 1;
            stats.sem[s.semester] = (stats.sem[s.semester] || 0) + 1;
            
            tableData.push({
              id,
              data: [
                null, id, s.name || 'N/A', s.phone || 'N/A', 
                s.department, s.semester,
                s.snacks === 'yes' ? "Yes" : "No",
                `<span class="table-status ${s.status}">${s.status}</span>`,
                generateActions(id, s)
              ]
            });
          }
        });

        return { total, booked, snacks, stats, tableData };
      }

      // Firebase data listener with optimization
      onValue(seatsRef, (snap) => {
        const data = snap.val() || {};
        currentBookingData = data;
        
        debounceUpdate(() => {
          const processed = processBookingData(data);
          
          // Update stats with animation
          updateStats(processed);
          
          // Update table if initialized
          if (seatTable) {
            updateTable(processed.tableData);
          }
          
          // Update charts
          updateCharts(processed.stats);
        });
      });

      function updateStats({total, booked, snacks}) {
        const updates = [
          { element: elements.totalSeatsStat, value: total },
          { element: elements.bookedSeatsStat, value: booked },
          { element: elements.leftSeatsStat, value: total - booked },
          { element: elements.needsSnacksStat, value: snacks }
        ];

        updates.forEach(({element, value}) => {
          if (element) {
            // Animate number change
            const current = parseInt(element.textContent) || 0;
            animateNumber(element, current, value);
          }
        });

        // Show stats, hide loading
        elements.statsLoading.classList.add('hidden');
        elements.statsContent.classList.remove('hidden');
      }

      function animateNumber(element, start, end, duration = 500) {
        const range = end - start;
        const increment = range / (duration / 16);
        let current = start;
        
        const timer = setInterval(() => {
          current += increment;
          if ((increment > 0 && current >= end) || (increment < 0 && current <= end)) {
            element.textContent = end;
            clearInterval(timer);
          } else {
            element.textContent = Math.round(current);
          }
        }, 16);
      }

      function updateTable(tableData) {
        if (!seatTable) return;
        
        seatTable.clear();
        tableData.forEach(({data}) => seatTable.row.add(data));
        seatTable.order([]).draw(false);
        
        // Update row numbers
        seatTable.on('order.dt search.dt', function () {
          seatTable.column(0, { search: 'applied', order: 'applied' }).nodes().each(function(cell, i) {
            cell.innerHTML = i + 1;
          });
        }).draw();
      }

      async function updateCharts(stats) {
        statusChart = await createChart(statusChart, 'statusChart', stats.status);
        deptChart = await createChart(deptChart, 'deptChart', stats.dept);
        semChart = await createChart(semChart, 'semChart', stats.sem);
      }

      function generateActions(id, s) {
        const editBtn = `<button class="btn btn-primary btn-sm edit-btn" data-seat-id="${id}">Edit</button>`;
        const statusBtn = s.status === 'confirmed' 
          ? '<button class="btn btn-success btn-sm ms-1" disabled>Confirmed</button>'
          : `<button class="btn btn-sm btn-${s.status === 'paid' ? 'warning' : 'primary'} action-btn ms-1"
              data-seat-id="${id}" data-new-status="${s.status === 'paid' ? 'confirmed' : 'paid'}">
              ${s.status === 'paid' ? 'Confirm' : 'Mark Paid'}</button>`;
        
        return editBtn + statusBtn;
      }

      // Event listeners with loading states
      function setupEventListeners() {
        // Action buttons with loading states
        $(document).on('click', '.action-btn', function() {
          const btn = $(this);
          const id = btn.data('seat-id');
          const newStatus = btn.data('new-status');
          
          showButtonLoading(btn);
          
          update(ref(db, `seats/${id}`), { status: newStatus })
            .catch(err => {
              alert("Error: " + err.message);
              hideButtonLoading(btn, newStatus === 'confirmed' ? "Confirm" : "Mark Paid");
            });
        });

        // Edit booking
        $(document).on('click', '.edit-btn', function() {
          const id = $(this).data('seat-id');
          const data = currentBookingData[id];
          if (!data) return alert("Booking not found.");
          
          populateEditModal(id, data);
          $('#editBookingModal').modal('show');
        });

        // Manual booking form
        $('#manualEntryForm').on('submit', function(e) {
          e.preventDefault();
          const btn = $(this).find('button[type="submit"]');
          
          showButtonLoading(btn);
          
          const bookingData = getFormData();
          if (!validateBookingData(bookingData)) {
            hideButtonLoading(btn, "Submit Booking");
            return;
          }
          
          submitManualBooking(bookingData, btn);
        });

        // Edit form submission
        $('#editBookingForm').on('submit', function(e) {
          e.preventDefault();
          const btn = $(this).find('button[type="submit"]');
          
          showButtonLoading(btn);
          
          const id = $('#editSeatId').val();
          const bookingData = getEditFormData();
          
          update(ref(db, `seats/${id}`), bookingData)
            .then(() => {
              $('#editBookingModal').modal('hide');
              hideButtonLoading(btn, "Save Changes");
            })
            .catch(err => {
              alert("Update failed: " + err.message);
              hideButtonLoading(btn, "Save Changes");
            });
        });

        // Export functions
        $('#exportCSV').on('click', exportCSV);
        $('#exportXLSX').on('click', exportXLSX);
      }

      function showButtonLoading(btn) {
        btn.addClass('btn-loading');
        btn.find('.btn-text').text('Loading...');
        btn.prop('disabled', true);
      }

      function hideButtonLoading(btn, originalText) {
        btn.removeClass('btn-loading');
        btn.find('.btn-text').text(originalText);
        btn.prop('disabled', false);
      }

      function getFormData() {
        return {
          id: $('#seatNumber').val().trim(),
          name: $('#userName').val().trim(),
          phone: $('#phoneNumber').val().trim(),
          department: $('#department').val(),
          semester: $('#semester').val(),
          snacks: $('#snacks').val(),
          status: $('#status').val()
        };
      }

      function getEditFormData() {
        return {
          name: $('#editUserName').val().trim(),
          phone: $('#editPhoneNumber').val().trim(),
          department: $('#editDepartment').val(),
          semester: $('#editSemester').val(),
          snacks: $('#editSnacks').val(),
          status: $('#editStatus').val()
        };
      }

      function validateBookingData({id, name, phone, department, semester, status}) {
        if (!id || !name || !department || !phone || !semester || !status) {
          alert("All fields are required.");
          return false;
        }
        return true;
      }

      function populateEditModal(id, data) {
        $('#editSeatId').val(id);
        $('#editUserName').val(data.name || "");
        $('#editPhoneNumber').val(data.phone || "");
        $('#editDepartment').val(data.department || "");
        $('#editSemester').val(data.semester || "");
        $('#editSnacks').val(data.snacks || "no");
        $('#editStatus').val(data.status || "paid");
      }

      function submitManualBooking(bookingData, btn) {
        const oneSeat = ref(db, `seats/${bookingData.id}`);
        
        onValue(oneSeat, (snap) => {
          if (snap.exists() && snap.val().status !== 'available') {
            alert("Seat already booked.");
            hideButtonLoading(btn, "Submit Booking");
          } else {
            const { id, ...seatData } = bookingData;
            update(oneSeat, seatData)
              .then(() => {
                alert("Booking added successfully.");
                document.getElementById('manualEntryForm').reset();
                hideButtonLoading(btn, "Submit Booking");
                toggleTab('#bookingSection', document.getElementById('bookingsTab'));
              })
              .catch(err => {
                alert("Failed: " + err.message);
                hideButtonLoading(btn, "Submit Booking");
              });
          }
        }, { onlyOnce: true });
      }

      function getBookingsForExport() {
        return Object.entries(currentBookingData)
          .filter(([_, val]) => val.status && val.status !== "available")
          .map(([id, val], i) => ({
            "#": i + 1,
            "Seat": id,
            "Name": val.name || "",
            "Phone": val.phone || "",
            "Department": val.department || "",
            "Semester": val.semester || "",
            "Snacks": val.snacks === "yes" ? "Yes" : "No",
            "Status": val.status
          }));
      }

      function exportCSV() {
        const data = getBookingsForExport();
        if (!data.length) return alert("No bookings to export.");
        
        const cols = Object.keys(data[0]);
        let csv = cols.join(",") + "\n";
        
        data.forEach(row => {
          csv += cols.map(c => `"${(row[c] + '').replace(/"/g, '""')}"`).join(",") + "\n";
        });
        
        downloadFile(csv, "bookings.csv", "text/csv");
      }

      async function exportXLSX() {
        const data = getBookingsForExport();
        if (!data.length) return alert("No bookings to export.");
        
        if (!window.XLSX) {
          alert("Export feature loading... Please try again in a moment.");
          return;
        }
        
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.json_to_sheet(data);
        XLSX.utils.book_append_sheet(wb, ws, "Bookings");
        XLSX.writeFile(wb, "bookings.xlsx");
      }

      function downloadFile(content, filename, mimeType) {
        const blob = new Blob([content], { type: mimeType });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
      }

      function showError(message) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'alert alert-danger alert-dismissible fade show position-fixed';
        errorDiv.style.cssText = 'top: 20px; right: 20px; z-index: 10000; max-width: 400px;';
        errorDiv.innerHTML = `
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(errorDiv);
        
        setTimeout(() => {
          if (errorDiv.parentNode) {
            errorDiv.parentNode.removeChild(errorDiv);
          }
        }, 5000);
      }

      // Initialize everything
      setupNavigation();
      setupEventListeners();
    }
  </script>
</body>
</html>
